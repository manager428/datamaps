var width=960,height=500,x=d3.scale.linear().range([0,width]),y=d3.scale.linear().range([0,height-40]),svg=d3.select("#chart").append("svg").attr("width",width).attr("height",height).style("padding-right","30px").append("g").attr("transform","translate("+x(1)+","+(height-20)+")scale(-1,-1)"),body=svg.append("g").attr("transform","translate(0,0)"),rules=svg.append("g"),title=svg.append("text").attr("class","title").attr("dy",".71em").attr("transform","translate("+x(1)+","+y(1)+")scale(-1,-1)").text(2e3);d3.csv("population.csv",function(e){function u(){if(!(s in e))return;title.text(s),body.transition().duration(750).attr("transform",function(e){return"translate("+x(s-i)+",0)"}),o.selectAll("rect").data(function(t){return e[s][t]||[0,0]}).transition().duration(750).attr("height",y)}e.forEach(function(e){e.people=+e.people,e.year=+e.year,e.age=+e.age});var t=0,n=d3.max(e,function(e){return e.age}),r=d3.min(e,function(e){return e.year}),i=d3.max(e,function(e){return e.year}),s=i;x.domain([0,n+5]),y.domain([0,d3.max(e,function(e){return e.people})]),rules=rules.selectAll(".rule").data(y.ticks(10)).enter().append("g").attr("class","rule").attr("transform",function(e){return"translate(0,"+y(e)+")"}),rules.append("line").attr("x2",width),rules.append("text").attr("x",6).attr("dy",".35em").attr("transform","rotate(180)").text(function(e){return Math.round(e/1e6)+"M"});var o=body.selectAll("g").data(d3.range(r-n,i+5,5)).enter().append("g").attr("transform",function(e){return"translate("+x(i-e)+",0)"});o.selectAll("rect").data(d3.range(2)).enter().append("rect").attr("x",1).attr("width",x(5)-2).attr("height",1e-6),o.append("text").attr("y",-6).attr("x",-x(5)/2).attr("transform","rotate(180)").attr("text-anchor","middle").style("fill","#fff").text(String),svg.append("g").selectAll("text").data(d3.range(0,n+5,5)).enter().append("text").attr("text-anchor","middle").attr("transform",function(e){return"translate("+(x(e)+x(5)/2)+",-4)scale(-1,-1)"}).attr("dy",".71em").text(String),e=d3.nest().key(function(e){return e.year}).key(function(e){return e.year-e.age}).rollup(function(e){return e.map(function(e){return e.people})}).map(e),d3.select(window).on("keydown",function(){switch(d3.event.keyCode){case 37:s=Math.max(r,s-10);break;case 39:s=Math.min(i,s+10)}u()}),u()})
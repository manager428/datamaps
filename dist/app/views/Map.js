define(["backbone","underscore","jquery","d3"],function(e,t,n,r){var i=e.View.extend({initialize:function(n){this._map=new e.Model;var i=this.options.pathData,s={type:"FeatureCollection",features:[]};t.isUndefined(r.geo[this.options.projection])&&(this.options.projection="albersUsa"),this.options.scope==="world"?this._map.set("pathData",t.reject(i.features,function(e){return e.properties.continent==="USA"})):this.options.scope==="usa"&&(this._map.set("pathData",t.reject(i.features,function(e){return e.properties.continent!=="USA"})),this.options.projection="albersUsa"),this._map.set("projection",r.geo[this.options.projection]()),this._map.set("path",r.geo.path().projection(this._map.get("projection"))),this._map.get("projection").scale(1e4)},mouseoverPath:function(e){var t=this,n=r.select(e.currentTarget),i=n[0][0].parentElement;n.style("stroke-width",t.options.highlightBorderWidth).style("stroke",t.options.highlightBorderColor),n.selectAll(".label").style("display","block"),n.remove(),t.options.highlightFillColor&&n.style("fill",t.options.highlightFillColor),i.appendChild(n[0][0])},mouseoutPath:function(e){var t=this;r.select(e.currentTarget).style("stroke-width",this.options.borderWidth).style("stroke",this.options.borderColor).style("fill",function(){return r.select(this).attr("data-fill")}),this.$el.find(".hoverover").hide()},render:function(){var e=this,i,s;i=this.$el.width(),s=this.$el.height();var o=n("<div/>").css({position:"relative"});this.$el.append(o),this.setElement(o);var u=this.projection=this._map.get("projection").scale(i).translate([i/2,s/2]),a=this.path=this._map.get("path"),f=this.svg=r.select(this.el).append("svg:svg").attr("width",i).attr("height",s),l=f.append("svg:g").attr("id","states"),c=l.selectAll("path").data(this._map.get("pathData")).enter(),h=c.append("path").attr("d",a).attr("data-type","country").style("stroke",e.options.borderColor).style("stroke-width",e.options.borderWidth).style("fill",function(t){var n,i=e.options.data[t.id];return i&&i.fillKey&&e.options.fills[i.fillKey]?n=e.options.fills[i.fillKey]:n=e.options.fills.defaultFill,r.select(this).attr("data-fill",n),n});this.options.showPopupOnHover&&(n('<div class="hoverover" style="z-index: 1001;"/>').appendTo(this.$el),h.on("mouseover",function(t){var r=e.$el.find(".hoverover"),i={geography:t,data:e.options.data[t.id]||{}};r.css({position:"absolute"}).html(e.options.popupTemplate(i)).show(),r.data("width",e.$el.find(".hoverover").width()),e.$el.trigger(n.Event("map-mouseover"),i)}),h.on("touchstart",function(t){var r=e.$el.find(".hoverover"),i={geography:t,data:e.options.data[t.id]||{}};r.css({position:"absolute"}).html(e.options.popupTemplate(i)).show(),r.data("width",e.$el.find(".hoverover").width()),e.$el.trigger(n.Event("map-touchstart"),i)}),h.on("mousemove",function(t){var n=r.mouse(this),i=e.$el.find(".hoverover");i.css({top:n[1]+20,left:n[0]-i.data("width")/2})}),h.on("mouseout",function(t){e.$el.find(".hoverover").hide();var r={geography:t,data:e.options.data[t.id]||{}};e.$el.trigger(n.Event("map-mouseout"),r)}),h.on("click",function(t){var r={geography:t,data:e.options.data[t.id]||{}};e.$el.trigger(n.Event("map-click"),r)})),this.options.highlightOnHover&&(e.$el.on("mouseover",'[data-type="country"]',t.bind(this.mouseoverPath,this)),e.$el.on("mouseout",'[data-type="country"]',t.bind(this.mouseoutPath,this)))}});return i})